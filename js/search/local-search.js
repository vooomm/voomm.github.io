class LocalSearch{constructor({path:e="",unescape:t=false,top_n_per_article:n=1}){this.path=e;this.unescape=t;this.top_n_per_article=n;this.isfetched=false;this.datas=null}getIndexByWord(e,t,n=false){const s=[];const o=new Set;if(!n){t=t.toLowerCase()}e.forEach((e=>{if(this.unescape){const t=document.createElement("div");t.innerText=e;e=t.innerHTML}const i=e.length;if(i===0)return;let r=0;let c=-1;if(!n){e=e.toLowerCase()}while((c=t.indexOf(e,r))>-1){s.push({position:c,word:e});o.add(e);r=c+i}}));s.sort(((e,t)=>{if(e.position!==t.position){return e.position-t.position}return t.word.length-e.word.length}));return[s,o]}mergeIntoSlice(e,t,n){let s=n[0];let{position:o,word:i}=s;const r=[];const c=new Set;while(o+i.length<=t&&n.length!==0){c.add(i);r.push({position:o,length:i.length});const e=o+i.length;n.shift();while(n.length!==0){s=n[0];o=s.position;i=s.word;if(e>o){n.shift()}else{break}}}return{hits:r,start:e,end:t,count:c.size}}highlightKeyword(e,t){let n="";let s=t.start;for(const{position:o,length:i}of t.hits){n+=e.substring(s,o);s=o+i;n+=`<mark class="search-keyword">${e.substr(o,i)}</mark>`}n+=e.substring(s,t.end);return n}getResultItems(e){const t=[];this.datas.forEach((({title:n,content:s,url:o})=>{const[i,r]=this.getIndexByWord(e,n);const[c,a]=this.getIndexByWord(e,s);const l=new Set([...r,...a]).size;const h=i.length+c.length;if(h===0)return;const d=[];if(i.length!==0){d.push(this.mergeIntoSlice(0,n.length,i))}let u=[];while(c.length!==0){const e=c[0];const{position:t}=e;const n=Math.max(0,t-20);const o=Math.min(s.length,t+100);u.push(this.mergeIntoSlice(n,o,c))}u.sort(((e,t)=>{if(e.count!==t.count){return t.count-e.count}else if(e.hits.length!==t.hits.length){return t.hits.length-e.hits.length}return e.start-t.start}));const g=parseInt(this.top_n_per_article,10);if(g>=0){u=u.slice(0,g)}let p="";o=new URL(o,location.origin);o.searchParams.append("highlight",e.join(" "));if(d.length!==0){p+=`<div class="local-search-hit-item"><a href="${o.href}"><span class="search-result-title">${this.highlightKeyword(n,d[0])}</span>`}else{p+=`<div class="local-search-hit-item"><a href="${o.href}"><span class="search-result-title">${n}</span>`}u.forEach((e=>{p+=`<p class="search-result">${this.highlightKeyword(s,e)}...</p></a>`}));p+="</div>";t.push({item:p,id:t.length,hitCount:h,includedCount:l})}));return t}fetchData(){const e=!this.path.endsWith("json");fetch(this.path).then((e=>e.text())).then((t=>{this.isfetched=true;this.datas=e?[...(new DOMParser).parseFromString(t,"text/xml").querySelectorAll("entry")].map((e=>({title:e.querySelector("title").textContent,content:e.querySelector("content").textContent,url:e.querySelector("url").textContent}))):JSON.parse(t);this.datas=this.datas.filter((e=>e.title)).map((e=>{e.title=e.title.trim();e.content=e.content?e.content.trim().replace(/<[^>]+>/g,""):"";e.url=decodeURIComponent(e.url).replace(/\/{2,}/g,"/");return e}));window.dispatchEvent(new Event("search:loaded"))}))}highlightText(e,t,n){const s=e.nodeValue;let o=t.start;const i=[];for(const{position:e,length:r}of t.hits){const t=document.createTextNode(s.substring(o,e));o=e+r;const c=document.createElement("mark");c.className=n;c.appendChild(document.createTextNode(s.substr(e,r)));i.push(t,c)}e.nodeValue=s.substring(o,t.end);i.forEach((t=>{e.parentNode.insertBefore(t,e)}))}highlightSearchWords(e){const t=new URL(location.href).searchParams.get("highlight");const n=t?t.split(" "):[];if(!n.length||!e)return;const s=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null);const o=[];while(s.nextNode()){if(!s.currentNode.parentNode.matches("button, select, textarea, .mermaid"))o.push(s.currentNode)}o.forEach((e=>{const[t]=this.getIndexByWord(n,e.nodeValue);if(!t.length)return;const s=this.mergeIntoSlice(0,e.nodeValue.length,t);this.highlightText(e,s,"search-keyword")}))}}window.addEventListener("load",(()=>{const{path:e,top_n_per_article:t,unescape:n,languages:s}=GLOBAL_CONFIG.localSearch;const o=new LocalSearch({path:e,top_n_per_article:t,unescape:n});const i=document.querySelector("#local-search-input input");const r=document.getElementById("local-search-stats-wrap");const c=document.getElementById("loading-status");const a=()=>{if(!o.isfetched)return;const e=i.value.trim().toLowerCase();if(e!=="")c.innerHTML='<i class="fas fa-spinner fa-pulse"></i>';const t=e.split(/[-\s]+/);const n=document.getElementById("local-search-results");let a=[];if(e.length>0){a=o.getResultItems(t)}if(t.length===1&&t[0]===""){n.classList.add("no-result");n.textContent=""}else if(a.length===0){n.textContent="";r.innerHTML=`<div class="search-result-stats">${s.hits_empty.replace(/\$\{query}/,e)}</div>`}else{a.sort(((e,t)=>{if(e.includedCount!==t.includedCount){return t.includedCount-e.includedCount}else if(e.hitCount!==t.hitCount){return t.hitCount-e.hitCount}return t.id-e.id}));const e=s.hits_stats.replace(/\$\{hits}/,a.length);n.classList.remove("no-result");n.innerHTML=`<div class="search-result-list">${a.map((e=>e.item)).join("")}</div>`;r.innerHTML=`<hr><div class="search-result-stats">${e}</div>`;window.pjax&&window.pjax.refresh(n)}c.innerHTML=""};let l=false;const h=document.getElementById("search-mask");const d=document.querySelector("#local-search .search-dialog");const u=()=>{if(window.innerWidth<768){d.style.setProperty("--search-height",window.innerHeight+"px")}};const g=()=>{const e=document.body.style;e.width="100%";e.overflow="hidden";btf.animateIn(h,"to_show 0.5s");btf.animateIn(d,"titleScale 0.5s");setTimeout((()=>{i.focus()}),300);if(!l){!o.isfetched&&o.fetchData();i.addEventListener("input",a);l=true}document.addEventListener("keydown",(function e(t){if(t.code==="Escape"){p();document.removeEventListener("keydown",e)}}));u();window.addEventListener("resize",u)};const p=()=>{const e=document.body.style;e.width="";e.overflow="";btf.animateOut(d,"search_close .5s");btf.animateOut(h,"to_hide 0.5s");window.removeEventListener("resize",u)};const m=()=>{document.querySelector("#search-button > .search").addEventListener("click",g)};const f=()=>{document.querySelector("#local-search .search-close-button").addEventListener("click",p);h.addEventListener("click",p);if(GLOBAL_CONFIG.localSearch.preload){o.fetchData()}o.highlightSearchWords(document.getElementById("article-container"))};window.addEventListener("search:loaded",(()=>{const e=document.getElementById("loading-database");e.nextElementSibling.style.display="block";e.remove()}));m();f();window.addEventListener("pjax:complete",(()=>{!btf.isHidden(h)&&p();o.highlightSearchWords(document.getElementById("article-container"));m()}))}));